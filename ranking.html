<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣麻將計分系統 - 16位玩家版</title>
    <style>
        /* 保持原有的CSS樣式，修改以下部分 */
        .player-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .player-field {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-field label {
            min-width: 60px;
        }
        
        select {
            flex-grow: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* 其他保持不變的樣式 */
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5dc;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2 {
            color: #8B0000;
            text-align: center;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .input-section, .score-section, .leaderboard {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .input-section {
            flex: 2;
            min-width: 400px;
        }
        
        .score-section {
            flex: 1;
            min-width: 300px;
        }
        
        .leaderboard {
            flex: 3;
            min-width: 500px;
        }
        
        /* 其他樣式保持不變... */
    </style>
</head>
<body>
    <h1>台灣麻將計分系統</h1>
    <h2>16位玩家版 - 美金2底1台</h2>
    
    <div class="container">
        <!-- 輸入區 -->
        <div class="input-section">
            <h3>新增牌局</h3>
            
            <div class="form-group">
                <label for="game-date">日期:</label>
                <input type="date" id="game-date" required>
            </div>
            
            <div class="form-group">
                <label>玩家選擇:</label>
                <div class="player-select">
                    <div class="player-field">
                        <label>莊家:</label>
                        <select id="player1" required>
                            <option value="">選擇玩家</option>
                            <!-- 玩家選項將由JavaScript動態生成 -->
                        </select>
                    </div>
                    <div class="player-field">
                        <label>下家:</label>
                        <select id="player2" required>
                            <option value="">選擇玩家</option>
                            <!-- 玩家選項將由JavaScript動態生成 -->
                        </select>
                    </div>
                    <div class="player-field">
                        <label>對家:</label>
                        <select id="player3" required>
                            <option value="">選擇玩家</option>
                            <!-- 玩家選項將由JavaScript動態生成 -->
                        </select>
                    </div>
                    <div class="player-field">
                        <label>上家:</label>
                        <select id="player4" required>
                            <option value="">選擇玩家</option>
                            <!-- 玩家選項將由JavaScript動態生成 -->
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="winner-section">
                <div class="form-group">
                    <label for="winner">贏家:</label>
                    <select id="winner" required onchange="updateWinTypeDisplay()">
                        <option value="">選擇贏家</option>
                        <option value="1">莊家</option>
                        <option value="2">下家</option>
                        <option value="3">對家</option>
                        <option value="4">上家</option>
                        <option value="0">流局</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tai-count">台數:</label>
                    <input type="number" id="tai-count" min="0" value="0" placeholder="輸入台數">
                </div>
                
                <div class="form-group">
                    <label for="win-type">胡牌方式:</label>
                    <select id="win-type" onchange="updateWinTypeDisplay()">
                        <option value="self-drawn">自摸</option>
                        <option value="discard">放槍</option>
                    </select>
                </div>
                
                <div class="loser-section" id="loser-section">
                    <div class="form-group">
                        <label for="loser">放槍者:</label>
                        <select id="loser">
                            <option value="">選擇放槍者</option>
                            <option value="1">莊家</option>
                            <option value="2">下家</option>
                            <option value="3">對家</option>
                            <option value="4">上家</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="addGame()">記錄牌局</button>
            </div>
        </div>
        
        <!-- 當前牌局記錄 -->
        <div class="score-section">
            <h3>牌局記錄</h3>
            <div class="game-list" id="game-list">
                <!-- 牌局記錄將在這裡顯示 -->
            </div>
            <button onclick="clearGames()" style="background-color: #f44336;">清除所有記錄</button>
        </div>
        
        <!-- 排行榜 -->
        <div class="leaderboard">
            <h3>排行榜</h3>
            <table id="leaderboard">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>玩家</th>
                        <th>總得分</th>
                        <th>總局數</th>
                        <th>平均得分</th>
                        <th>胡牌次數</th>
                        <th>自摸次數</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 排行榜數據將在這裡顯示 -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // 16位預設玩家
        const allPlayers = [
            "玩家1", "玩家2", "玩家3", "玩家4", 
            "玩家5", "玩家6", "玩家7", "玩家8",
            "玩家9", "玩家10", "玩家11", "玩家12",
            "玩家13", "玩家14", "玩家15", "玩家16"
        ];
        
        // 儲存所有牌局記錄
        let games = JSON.parse(localStorage.getItem('mahjongGames')) || [];
        
        // 初始化頁面
        window.onload = function() {
            initPlayerSelectors();
            updateGameList();
            updateLeaderboard();
            
            // 設置默認日期為今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('game-date').value = today;
        };
        
        // 初始化玩家選擇器
        function initPlayerSelectors() {
            const playerSelectors = [
                document.getElementById('player1'),
                document.getElementById('player2'),
                document.getElementById('player3'),
                document.getElementById('player4')
            ];
            
            playerSelectors.forEach(selector => {
                // 保留第一個"選擇玩家"選項
                while (selector.options.length > 1) {
                    selector.remove(1);
                }
                
                // 添加所有玩家選項
                allPlayers.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player;
                    option.textContent = player;
                    selector.appendChild(option);
                });
            });
        }
        
        // 根據胡牌方式更新顯示
        function updateWinTypeDisplay() {
            const winner = document.getElementById('winner').value;
            const winType = document.getElementById('win-type').value;
            const loserSection = document.getElementById('loser-section');
            
            if (winType === 'discard' && winner !== '0') {
                loserSection.style.display = 'block';
                
                // 更新放槍者選項，排除贏家
                const loserSelect = document.getElementById('loser');
                loserSelect.innerHTML = '<option value="">選擇放槍者</option>';
                
                for (let i = 1; i <= 4; i++) {
                    if (i.toString() !== winner) {
                        const positionName = getPositionName(i);
                        loserSelect.innerHTML += `<option value="${i}">${positionName}</option>`;
                    }
                }
            } else {
                loserSection.style.display = 'none';
            }
        }
        
        // 獲取位置名稱
        function getPositionName(position) {
            switch(position) {
                case 1: return "莊家";
                case 2: return "下家";
                case 3: return "對家";
                case 4: return "上家";
                default: return "";
            }
        }
        
        // 添加新牌局
        function addGame() {
            // 獲取玩家姓名
            const player1 = document.getElementById('player1').value;
            const player2 = document.getElementById('player2').value;
            const player3 = document.getElementById('player3').value;
            const player4 = document.getElementById('player4').value;
            
            // 驗證輸入
            if (!player1 || !player2 || !player3 || !player4) {
                alert('請選擇所有玩家！');
                return;
            }
            
            // 檢查玩家是否重複
            const players = [player1, player2, player3, player4];
            const uniquePlayers = [...new Set(players)];
            if (uniquePlayers.length !== 4) {
                alert('玩家不能重複！');
                return;
            }
            
            const winner = document.getElementById('winner').value;
            if (winner === '') {
                alert('請選擇贏家！');
                return;
            }
            
            const taiCount = parseInt(document.getElementById('tai-count').value) || 0;
            const winType = document.getElementById('win-type').value;
            const gameDate = document.getElementById('game-date').value;
            
            // 如果是放槍，檢查放槍者
            let loser = null;
            if (winType === 'discard' && winner !== '0') {
                loser = document.getElementById('loser').value;
                if (!loser) {
                    alert('請選擇放槍者！');
                    return;
                }
            }
            
            // 創建牌局對象
            const game = {
                date: gameDate,
                players: [
                    { name: player1, position: 1 }, // 莊家
                    { name: player2, position: 2 }, // 下家
                    { name: player3, position: 3 }, // 對家
                    { name: player4, position: 4 }  // 上家
                ],
                winner: parseInt(winner),
                taiCount: taiCount,
                winType: winType,
                loser: loser ? parseInt(loser) : null,
                timestamp: new Date().getTime()
            };
            
            // 計算得分
            calculateScores(game);
            
            // 添加到記錄
            games.push(game);
            saveGames();
            
            // 更新顯示
            updateGameList();
            updateLeaderboard();
            
            // 重置表單
            document.getElementById('tai-count').value = '0';
        }
        
        // 計算得分 (2底1台)
        function calculateScores(game) {
            const baseScore = 2; // 底
            const taiScore = game.taiCount; // 台
            
            // 計算總得分
            let totalScore = baseScore + taiScore;
            
            // 根據胡牌方式調整得分
            if (game.winType === 'self-drawn') {
                // 自摸: 三家各付總分
                game.scores = game.players.map((player, index) => {
                    if (index + 1 === game.winner) {
                        return totalScore * 3; // 贏家獲得三家付的分數
                    } else {
                        return -totalScore; // 其他玩家各付總分
                    }
                });
            } else if (game.winner > 0) {
                // 放槍: 放槍者付總分*2，其他玩家不付分
                game.scores = game.players.map((player, index) => {
                    if (index + 1 === game.winner) {
                        return totalScore * 2; // 贏家獲得放槍者付的分數
                    } else if (index + 1 === game.loser) {
                        return -totalScore * 2; // 放槍者付分
                    } else {
                        return 0; // 其他玩家不付分
                    }
                });
            } else {
                // 流局: 所有人得分為0
                game.scores = [0, 0, 0, 0];
            }
        }
        
        // 更新牌局列表
        function updateGameList() {
            const gameList = document.getElementById('game-list');
            gameList.innerHTML = '';
            
            if (games.length === 0) {
                gameList.innerHTML = '<p>暫無牌局記錄</p>';
                return;
            }
            
            // 按時間倒序排列
            const sortedGames = [...games].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedGames.forEach((game, index) => {
                const gameItem = document.createElement('div');
                gameItem.className = 'game-item';
                
                // 查找贏家姓名
                let winnerName = '流局';
                if (game.winner > 0) {
                    winnerName = game.players[game.winner - 1].name;
                }
                
                // 查找放槍者姓名
                let loserInfo = '';
                if (game.winType === 'discard' && game.loser) {
                    const loserName = game.players[game.loser - 1].name;
                    loserInfo = ` (放槍者: ${loserName})`;
                }
                
                // 顯示牌局信息
                gameItem.innerHTML = `
                    <p><strong>${game.date}</strong></p>
                    <p>玩家: ${game.players.map(p => `${p.name}(${getPositionName(p.position)})`).join(', ')}</p>
                    <p>贏家: ${winnerName} ${game.winner > 0 ? `(${game.taiCount}台, ${game.winType === 'self-drawn' ? '自摸' : '放槍'}${loserInfo})` : ''}</p>
                    <p>得分: ${game.players.map((p, i) => `${p.name}: ${game.scores[i] > 0 ? '+' : ''}${game.scores[i]}`).join(', ')}</p>
                `;
                
                gameList.appendChild(gameItem);
            });
        }
        
        // 更新排行榜
        function updateLeaderboard() {
            const leaderboard = document.getElementById('leaderboard').querySelector('tbody');
            leaderboard.innerHTML = '';
            
            if (games.length === 0) {
                leaderboard.innerHTML = '<tr><td colspan="7">暫無數據</td></tr>';
                return;
            }
            
            // 計算每個玩家的總得分、局數、胡牌次數和自摸次數
            const playerStats = {};
            
            // 初始化所有玩家
            allPlayers.forEach(player => {
                playerStats[player] = {
                    totalScore: 0,
                    gameCount: 0,
                    winCount: 0,
                    selfDrawnCount: 0
                };
            });
            
            // 統計遊戲數據
            games.forEach(game => {
                game.players.forEach((player, index) => {
                    playerStats[player.name].totalScore += game.scores[index];
                    playerStats[player.name].gameCount += 1;
                    
                    // 統計胡牌次數和自摸次數
                    if (game.winner === index + 1) {
                        playerStats[player.name].winCount += 1;
                        if (game.winType === 'self-drawn') {
                            playerStats[player.name].selfDrawnCount += 1;
                        }
                    }
                });
            });
            
            // 過濾有參與遊戲的玩家
            const activePlayers = Object.entries(playerStats)
                .filter(([name, stats]) => stats.gameCount > 0)
                .map(([name, stats]) => ({
                    name,
                    totalScore: stats.totalScore,
                    gameCount: stats.gameCount,
                    averageScore: stats.totalScore / stats.gameCount,
                    winCount: stats.winCount,
                    selfDrawnCount: stats.selfDrawnCount
                }))
                .sort((a, b) => b.totalScore - a.totalScore);
            
            // 顯示排行榜
            activePlayers.forEach((player, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.totalScore > 0 ? '+' : ''}${player.totalScore}</td>
                    <td>${player.gameCount}</td>
                    <td>${player.averageScore.toFixed(1)}</td>
                    <td>${player.winCount}</td>
                    <td>${player.selfDrawnCount}</td>
                `;
                
                leaderboard.appendChild(row);
            });
        }
        
        // 保存牌局記錄到本地存儲
        function saveGames() {
            localStorage.setItem('mahjongGames', JSON.stringify(games));
        }
        
        // 清除所有記錄
        function clearGames() {
            if (confirm('確定要清除所有牌局記錄嗎？此操作無法恢復！')) {
                games = [];
                saveGames();
                updateGameList();
                updateLeaderboard();
            }
        }
    </script>
</body>
</html>